<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0" />

    <!-- 社交媒体分享预览 -->
    <meta property="og:title" content="子杰暑假课程安排" />
    <meta property="og:description" content="2025年暑假学习计划，课程安排一目了然，支持在线编辑和课程提醒" />
    <meta property="og:image" content="https://images.unsplash.com/photo-1434030216411-0b793f4b4173?w=1200&h=630&fit=crop&auto=format" />
    <meta property="og:url" content="https://damonxuda.github.io/course-schedule/" />
    <meta property="og:type" content="website" />
    
    <!-- 微信分享优化 -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="子杰暑假课程安排" />
    <meta name="twitter:description" content="2025年暑假学习计划，课程安排一目了然，支持在线编辑和课程提醒" />
    <meta name="twitter:image" content="https://images.unsplash.com/photo-1434030216411-0b793f4b4173?w=1200&h=630&fit=crop&auto=format" />

    <!-- PWA 支持 -->
    <meta name="theme-color" content="#667eea" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="课程表" />
    <link
      rel="apple-touch-icon"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23667eea'/><text x='50' y='60' font-size='50' text-anchor='middle' fill='white'>📚</text></svg>"
    />
    <link
      rel="manifest"
      href="data:application/json,{
        'name': '暑假课程日历',
        'short_name': '课程表',
        'start_url': '.',
        'display': 'standalone',
        'background_color': '#667eea',
        'theme_color': '#667eea',
        'icons': [
            {
                'src': 'data:image/svg+xml,<svg xmlns=\\'http://www.w3.org/2000/svg\\' viewBox=\\'0 0 100 100\\'><rect width=\\'100\\' height=\\'100\\' fill=\\'%23667eea\\'/><text x=\\'50\\' y=\\'60\\' font-size=\\'50\\' text-anchor=\\'middle\\' fill=\\'white\\'>📚</text></svg>',
                'sizes': '192x192',
                'type': 'image/svg+xml'
            }
        ]
    }"
    />
    <title>暑假课程日历提醒</title>

    <style>
      /* ================================
         CSS 样式部分 - 开始
         ================================ */
      
      /* 基础样式 */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Microsoft YaHei", Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        touch-action: manipulation;
      }

      /* 容器布局 */
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      /* 头部样式 */
      .header {
        background: linear-gradient(135deg, #ff6b6b, #ffa726);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 1.8rem;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .current-date {
        font-size: 1.3rem;
        opacity: 0.9;
      }

      /* 主内容区域 */
      .main-content {
        padding: 30px;
      }

      /* 导航按钮 */
      .calendar-nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .nav-btn {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.8rem;
        transition: all 0.3s ease;
        touch-action: manipulation;
        user-select: none;
      }

      .nav-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
      }

      .nav-btn:active {
        transform: translateY(0);
      }

      .date-display {
        font-size: 1.2rem;
        font-weight: bold;
        color: #333;
      }

      /* 课程展示区域 */
      .today-schedule {
        background: #f8f9ff;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 30px;
        border-left: 5px solid #667eea;
      }

      .schedule-title {
        font-size: 1.5rem;
        color: #333;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
      }

      .course-item {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease;
      }

      .course-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .course-time {
        font-weight: bold;
        color: #ff6b6b;
        font-size: 1.1rem;
        margin-bottom: 5px;
      }

      .course-name {
        color: #333;
        font-size: 1rem;
      }

      /* 课程类型样式 */
      .course-smk { background: #ffe066; border-left: 4px solid #ffd700; }
      .course-island { background: #66e0ff; border-left: 4px solid #00bcd4; }
      .course-teacher { background: #ff9999; border-left: 4px solid #f44336; }
      .course-english { background: #99ff99; border-left: 4px solid #4caf50; }
      .course-exercise { background: #90ee90; border-left: 4px solid #32cd32; }
      .course-homework { background: #ffb6c1; border-left: 4px solid #ff69b4; }
      .course-art { background: #ffb3e6; border-left: 4px solid #e91e63; }
      .course-other { background: #e0e0e0; border-left: 4px solid #757575; }

      .no-courses {
        text-align: center;
        color: #666;
        font-size: 1.2rem;
        padding: 40px;
      }

      /* 统计卡片 */
      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 30px;
      }

      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: #667eea;
      }

      .stat-label {
        color: #666;
        margin-top: 5px;
      }

      /* 编辑按钮 */
      .edit-toggle {
        background: linear-gradient(135deg, #ff6b6b, #ffa726);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        margin-top: 20px;
        transition: all 0.3s ease;
        user-select: none;
      }

      .edit-toggle:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
      }

      /* 编辑器样式 */
      .editor-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 1000;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .editor-panel {
        background: white;
        border-radius: 15px;
        padding: 30px;
        max-width: 500px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        position: relative;
      }

      .editor-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
      }

      .editor-title {
        font-size: 1.4rem;
        font-weight: bold;
        color: #333;
      }

      .close-btn {
        background: #f0f0f0;
        border: none;
        border-radius: 50%;
        width: 35px;
        height: 35px;
        cursor: pointer;
        font-size: 1.2rem;
        color: #666;
        transition: all 0.3s ease;
      }

      .close-btn:hover {
        background: #e0e0e0;
        transform: scale(1.1);
      }

      /* 表单样式 */
      .form-group {
        margin-bottom: 20px;
      }

      .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: #333;
        font-size: 0.9rem;
      }

      .form-input, .form-select, .form-textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
        box-sizing: border-box;
      }

      .form-input:focus, .form-select:focus, .form-textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .form-textarea {
        min-height: 80px;
        resize: vertical;
      }

      .time-inputs {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        gap: 10px;
        align-items: center;
      }

      .time-separator {
        text-align: center;
        font-weight: bold;
        color: #666;
      }

      /* 课程列表编辑 */
      .course-list {
        margin-bottom: 20px;
      }

      .course-item-edit {
        background: #f8f9ff;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-left: 4px solid #667eea;
      }

      .course-info {
        flex-grow: 1;
      }

      .course-time-edit {
        font-weight: bold;
        color: #ff6b6b;
        font-size: 0.9rem;
      }

      .course-name-edit {
        color: #333;
        font-size: 0.95rem;
        margin-top: 2px;
      }

      .course-actions {
        display: flex;
        gap: 8px;
      }

      /* 按钮样式 */
      .btn-small {
        padding: 6px 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.8rem;
        transition: all 0.3s ease;
      }

      .btn-edit {
        background: #667eea;
        color: white;
      }

      .btn-edit:hover {
        background: #5a6fd8;
        transform: translateY(-1px);
      }

      .btn-delete {
        background: #ff6b6b;
        color: white;
      }

      .btn-delete:hover {
        background: #ff5252;
        transform: translateY(-1px);
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.3s ease;
        width: 100%;
        margin-top: 10px;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .btn-secondary {
        background: #f0f0f0;
        color: #333;
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        margin-right: 10px;
      }

      .btn-secondary:hover {
        background: #e0e0e0;
        transform: translateY(-1px);
      }

      .editor-actions {
        display: flex;
        justify-content: flex-end;
        margin-top: 25px;
        padding-top: 20px;
        border-top: 2px solid #f0f0f0;
      }

      /* 快速时间选择 */
      .quick-times {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 8px;
        margin-top: 10px;
      }

      .quick-time-btn {
        background: #f8f9ff;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 0.85rem;
        transition: all 0.3s ease;
        text-align: center;
      }

      .quick-time-btn:hover {
        border-color: #667eea;
        background: #667eea;
        color: white;
      }

      /* 移动端适配 */
      @media screen and (max-width: 768px) {
        .editor-panel {
          padding: 20px;
          margin: 10px;
        }
        
        .time-inputs {
          grid-template-columns: 1fr;
          gap: 15px;
        }
        
        .time-separator {
          order: -1;
        }
        
        .quick-times {
          grid-template-columns: repeat(2, 1fr);
        }
        
        .course-item-edit {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }
        
        .course-actions {
          width: 100%;
          justify-content: flex-end;
        }
      }

      /* ================================
         CSS 样式部分 - 结束
         ================================ */
    </style>
  </head>

  <body>
    <!-- ================================
         HTML 结构部分 - 开始
         ================================ -->
    
    <div class="container">
      <div class="header">
        <h1>🎓 子杰暑假课程安排</h1>
        <div class="current-date" id="currentDate"></div>
      </div>

      <div class="main-content">
        <div class="calendar-nav">
          <button class="nav-btn" id="prevBtn">← 前一天</button>
          <div class="date-display" id="displayDate"></div>
          <button class="nav-btn" id="nextBtn">后一天 →</button>
        </div>

        <div class="today-schedule">
          <div class="schedule-title">今日课程安排</div>
          <div id="scheduleContent"></div>
        </div>

        <div class="stats">
          <div class="stat-card">
            <div class="stat-number" id="totalCourses">0</div>
            <div class="stat-label">今日课程数</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="courseHours">0</div>
            <div class="stat-label">课程小时数</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="categoryCount">0</div>
            <div class="stat-label">课程类型</div>
          </div>
        </div>

        <button class="edit-toggle" onclick="handleEditClick()">
          ✏️ 编辑课程安排
        </button>
      </div>
    </div>

    <!-- 编辑器界面 -->
    <div class="editor-overlay" id="editorOverlay">
      <div class="editor-panel">
        <div class="editor-header">
          <div class="editor-title">📅 课程安排编辑器</div>
          <button class="close-btn" onclick="handleCloseEditor()">×</button>
        </div>

        <div class="form-group">
          <label class="form-label">📅 选择日期</label>
          <input type="date" class="form-input" id="editDate" onchange="handleLoadDateCourses()">
        </div>

        <div class="course-list" id="courseList">
          <!-- 当前日期的课程列表 -->
        </div>

        <div class="form-group">
          <label class="form-label">⏰ 课程时间</label>
          <div class="time-inputs">
            <input type="time" class="form-input" id="startTime" placeholder="开始时间">
            <div class="time-separator">至</div>
            <input type="time" class="form-input" id="endTime" placeholder="结束时间">
          </div>
          <div class="quick-times">
            <button class="quick-time-btn" onclick="handleSetQuickTime('09:00', '11:00')">09:00-11:00</button>
            <button class="quick-time-btn" onclick="handleSetQuickTime('13:00', '15:00')">13:00-15:00</button>
            <button class="quick-time-btn" onclick="handleSetQuickTime('15:30', '17:30')">15:30-17:30</button>
            <button class="quick-time-btn" onclick="handleSetQuickTime('19:00', '21:00')">19:00-21:00</button>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">📚 课程名称</label>
          <input type="text" class="form-input" id="courseName" placeholder="请输入课程名称">
        </div>

        <div class="form-group">
          <label class="form-label">🎯 课程类型</label>
          <select class="form-select" id="courseType">
            <option value="smk">SMK英语</option>
            <option value="island">岛主五竞</option>
            <option value="teacher">普老师刷题</option>
            <option value="english">英语YH</option>
            <option value="exercise">体育锻炼</option>
            <option value="homework">作业时间</option>
            <option value="art">艺术课程</option>
            <option value="other">其他</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">📝 备注说明（可选）</label>
          <textarea class="form-textarea" id="courseNote" placeholder="添加课程备注或说明"></textarea>
        </div>

        <button class="btn-primary" onclick="handleSaveCourse()" id="saveBtn">
          ➕ 添加课程
        </button>

        <div class="editor-actions">
          <button class="btn-secondary" onclick="handleCloseEditor()">取消</button>
        </div>
      </div>
    </div>

    <!-- ================================
         HTML 结构部分 - 结束
         ================================ -->

    <!-- Supabase SDK 加载 -->
    <script type="module">
      // ================================
      // Supabase 初始化部分 - 开始
      // ================================
      
      const supabaseConfig = {
        url: "https://exnfrclagndigmdybicg.supabase.co",
        anonKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4bmZyY2xhZ25kaWdtZHliaWNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEyODMzMjUsImV4cCI6MjA2Njg1OTMyNX0.kDPQuEKP6pSAmcbNn2cuUZZDC5fBT_YYdAYAve9qY9w"
      };

      window.useSupabase = true;
      
      // 初始化Supabase
      import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/+esm').then(({ createClient }) => {
        const supabase = createClient(supabaseConfig.url, supabaseConfig.anonKey);
        window.supabase = supabase;
        
        // 初始化应用
        initApp();
      }).catch(error => {
        console.error('Supabase初始化失败:', error);
        window.useSupabase = false;
        initApp();
      });

      // ================================
      // Supabase 初始化部分 - 结束
      // ================================
    </script>

    <script>
      // ================================
      // 配置和常量部分 - 开始
      // ================================
      
      // 课程类型定义
      const CourseTypes = {
        smk: 'SMK英语',
        island: '岛主五竞',
        teacher: '普老师刷题',
        english: '英语YH',
        exercise: '体育锻炼',
        homework: '作业时间',
        art: '艺术课程',
        other: '其他'
      };

      // 默认课程数据（旧格式，用于兼容和迁移）
      const defaultSchedules = {
        "2025-06-30": [
          { time: "13:00-15:00", course: "英语SMK", type: "smk", category: "学科辅导" },
          { time: "19:00-21:00", course: "普老师刷题A", type: "teacher", category: "学科辅导" }
        ],
        "2025-07-01": [
          { time: "12:30-15:00", course: "岛主五竞", type: "island", category: "学科辅导" }
        ],
        "2025-07-02": [],
        "2025-07-03": [
          { time: "12:30-15:00", course: "岛主五竞", type: "island", category: "学科辅导" },
          { time: "19:00-21:00", course: "普老师刷题A", type: "teacher", category: "学科辅导" }
        ],
        "2025-07-04": [
          { time: "13:00-15:00", course: "英语SMK", type: "smk", category: "学科辅导" }
        ]
        // 其他日期数据...
      };

      // ================================
      // 配置和常量部分 - 结束
      // ================================

      // ================================
      // 统一数据模型部分 - 开始
      // ================================
      
      const ScheduleUtils = {
        // 生成UUID
        generateUUID() {
          return crypto.randomUUID();
        },

        // 创建新课程
        createNew(date, start_time, end_time, course_name, course_type, note = '') {
          return {
            id: this.generateUUID(),
            date,
            start_time,
            end_time,
            course_name,
            course_type,
            category: '学科辅导',
            note,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString(),
            created_by: 'github_app'
          };
        },

        // 格式化时间显示
        formatTimeDisplay(start_time, end_time) {
          return `${start_time}-${end_time}`;
        },

        // 计算课程时长
        calculateDuration(start_time, end_time) {
          const start = new Date(`2000-01-01T${start_time}:00`);
          const end = new Date(`2000-01-01T${end_time}:00`);
          return (end - start) / (1000 * 60 * 60); // 转换为小时
        },

        // 按时间排序
        sortByTime(schedules) {
          return [...schedules].sort((a, b) => {
            const timeA = new Date(`2000-01-01T${a.start_time}:00`);
            const timeB = new Date(`2000-01-01T${b.start_time}:00`);
            return timeA - timeB;
          });
        },

        // 验证课程数据
        validate(schedule) {
          const errors = [];
          
          if (!schedule.course_name || schedule.course_name.trim() === '') {
            errors.push('课程名称不能为空');
          }
          
          if (!schedule.start_time || !schedule.end_time) {
            errors.push('开始时间和结束时间不能为空');
          }
          
          const timeRegex = /^([0-1]?\d|2[0-3]):[0-5]\d$/;
          if (schedule.start_time && !timeRegex.test(schedule.start_time)) {
            errors.push('开始时间格式错误');
          }
          
          if (schedule.end_time && !timeRegex.test(schedule.end_time)) {
            errors.push('结束时间格式错误');
          }
          
          if (schedule.start_time && schedule.end_time) {
            const start = new Date(`2000-01-01T${schedule.start_time}:00`);
            const end = new Date(`2000-01-01T${schedule.end_time}:00`);
            
            if (start >= end) {
              errors.push('结束时间必须晚于开始时间');
            }
          }
          
          return {
            isValid: errors.length === 0,
            errors: errors
          };
        },

        // 转换为显示格式（兼容旧界面）
        toDisplayFormat(schedule) {
          return {
            id: schedule.id,
            time: this.formatTimeDisplay(schedule.start_time, schedule.end_time),
            course: schedule.course_name,
            type: schedule.course_type,
            category: schedule.category,
            note: schedule.note || ''
          };
        }
      };

      // ================================
      // 统一数据模型部分 - 结束
      // ================================

      // ================================
      // 数据库操作层 - 开始
      // ================================
      
      // ================================
      // 数据库操作层 - 开始
      // ================================
      
      const DatabaseManager = {
        // 从Supabase加载所有课程数据
        async loadAllSchedules() {
          try {
            console.log('从Supabase加载统一格式数据...');
            
            const { data, error } = await window.supabase
              .from('schedules')
              .select('*')
              .order('date')
              .order('start_time');
              
            if (error) {
              console.error('从Supabase加载数据失败:', error);
              return { success: false, error: error.message };
            }

            console.log('从Supabase加载了', data?.length || 0, '条课程记录');
            return { success: true, data: data || [] };
          } catch (error) {
            console.error('加载Supabase数据异常:', error);
            return { success: false, error: error.message };
          }
        },

        // 保存单个课程到Supabase
        async saveSchedule(schedule) {
          try {
            const { data, error } = await window.supabase
              .from('schedules')
              .insert(schedule)
              .select()
              .single();
              
            if (error) {
              console.error('保存到Supabase失败:', error);
              return { success: false, error: error.message };
            }

            return { success: true, data: data };
          } catch (error) {
            console.error('保存课程异常:', error);
            return { success: false, error: error.message };
          }
        },

        // 更新课程
        async updateSchedule(id, updates) {
          try {
            const { data, error } = await window.supabase
              .from('schedules')
              .update(updates)
              .eq('id', id)
              .select()
              .single();
              
            if (error) {
              console.error('更新Supabase失败:', error);
              return { success: false, error: error.message };
            }

            return { success: true, data: data };
          } catch (error) {
            console.error('更新课程异常:', error);
            return { success: false, error: error.message };
          }
        },

        // 删除课程
        async deleteSchedule(id) {
          try {
            const { error } = await window.supabase
              .from('schedules')
              .delete()
              .eq('id', id);
              
            if (error) {
              console.error('删除Supabase数据失败:', error);
              return { success: false, error: error.message };
            }

            return { success: true };
          } catch (error) {
            console.error('删除课程异常:', error);
            return { success: false, error: error.message };
          }
        },

        // 批量保存课程（用于迁移）
        async batchSaveSchedules(schedules) {
          try {
            const { data, error } = await window.supabase
              .from('schedules')
              .insert(schedules)
              .select();
              
            if (error) {
              console.error('批量保存失败:', error);
              return { success: false, error: error.message };
            }

            console.log('成功批量保存', data?.length || 0, '条记录');
            return { success: true, data: data };
          } catch (error) {
            console.error('批量保存异常:', error);
            return { success: false, error: error.message };
          }
        },

        // 设置实时监听
        setupRealtimeListeners(onUpdate) {
          try {
            const subscription = window.supabase
              .channel('schedule-changes')
              .on('postgres_changes', {
                event: '*',
                schema: 'public',
                table: 'schedules'
              }, (payload) => {
                console.log('实时数据更新:', payload);
                if (onUpdate) {
                  onUpdate(payload);
                }
              })
              .subscribe();

            console.log('Supabase实时监听已启动');
            return subscription;
          } catch (error) {
            console.error('设置实时监听失败:', error);
            return null;
          }
        }
      };

      // ================================
      // 数据库操作层 - 结束
      // ================================

      // ================================
      // 课程管理业务逻辑层 - 开始
      // ================================
      
      const ScheduleManager = {
        schedules: {},
        realtimeSubscription: null,
        
        // 初始化数据
        async init() {
          if (window.useSupabase && window.supabase) {
            await this.loadFromDatabase();
            this.setupRealtimeSync();
          } else {
            this.loadFromLocal();
          }
        },

        // 从数据库加载数据
        async loadFromDatabase() {
          const result = await DatabaseManager.loadAllSchedules();
          
          if (result.success) {
            // 按日期分组
            this.schedules = {};
            result.data.forEach(schedule => {
              const dateStr = schedule.date;
              if (!this.schedules[dateStr]) {
                this.schedules[dateStr] = [];
              }
              this.schedules[dateStr].push(schedule);
            });

            // 如果数据库为空，迁移默认数据
            if (result.data.length === 0) {
              await this.migrateDefaultData();
            }
          } else {
            console.error('数据库加载失败，使用默认数据');
            this.loadDefaultData();
          }
        },

        // 加载默认数据
        loadDefaultData() {
          this.schedules = {};
          
          // 转换默认数据为统一格式
          Object.keys(defaultSchedules).forEach(date => {
            this.schedules[date] = defaultSchedules[date].map(oldCourse => {
              const timeMatch = oldCourse.time.match(/(\d+):(\d+)-(\d+):(\d+)/);
              return ScheduleUtils.createNew(
                date,
                `${timeMatch[1]}:${timeMatch[2]}`,
                `${timeMatch[3]}:${timeMatch[4]}`,
                oldCourse.course,
                oldCourse.type,
                oldCourse.note || ''
              );
            });
          });
        },

        // 迁移默认数据到数据库
        async migrateDefaultData() {
          console.log('迁移默认数据到数据库...');
          this.loadDefaultData();
          
          const allSchedules = [];
          Object.keys(this.schedules).forEach(date => {
            this.schedules[date].forEach(schedule => {
              allSchedules.push(schedule);
            });
          });

          if (allSchedules.length > 0) {
            const result = await DatabaseManager.batchSaveSchedules(allSchedules);
            if (!result.success) {
              console.error('迁移数据失败:', result.error);
            }
          }
        },

        // 设置实时同步
        setupRealtimeSync() {
          this.realtimeSubscription = DatabaseManager.setupRealtimeListeners((payload) => {
            this.handleRealtimeUpdate(payload);
          });
        },

        // 处理实时更新
        handleRealtimeUpdate(payload) {
          const { eventType, new: newRecord, old: oldRecord } = payload;
          
          if (eventType === 'INSERT' && newRecord) {
            const dateStr = newRecord.date;
            if (!this.schedules[dateStr]) {
              this.schedules[dateStr] = [];
            }
            this.schedules[dateStr].push(newRecord);
            this.schedules[dateStr] = ScheduleUtils.sortByTime(this.schedules[dateStr]);
          } else if (eventType === 'UPDATE' && newRecord) {
            const dateStr = newRecord.date;
            if (this.schedules[dateStr]) {
              const index = this.schedules[dateStr].findIndex(s => s.id === newRecord.id);
              if (index !== -1) {
                this.schedules[dateStr][index] = newRecord;
                this.schedules[dateStr] = ScheduleUtils.sortByTime(this.schedules[dateStr]);
              }
            }
          } else if (eventType === 'DELETE' && oldRecord) {
            const dateStr = oldRecord.date;
            if (this.schedules[dateStr]) {
              this.schedules[dateStr] = this.schedules[dateStr].filter(s => s.id !== oldRecord.id);
            }
          }
          
          // 刷新UI显示
          if (typeof UIManager !== 'undefined' && UIManager.updateDisplay) {
            UIManager.updateDisplay();
          }
        },

        // 从localStorage加载（备用方案）
        loadFromLocal() {
          try {
            const saved = localStorage.getItem('scheduleData_unified_backup');
            if (saved) {
              this.schedules = JSON.parse(saved);
            } else {
              this.loadDefaultData();
            }
          } catch (error) {
            console.error('从localStorage加载失败:', error);
            this.loadDefaultData();
          }
        },

        // 保存到localStorage（备用方案）
        saveToLocal() {
          try {
            localStorage.setItem('scheduleData_unified_backup', JSON.stringify(this.schedules));
          } catch (error) {
            console.error('保存到localStorage失败:', error);
          }
        },

        // 获取指定日期的课程（统一格式）
        getScheduleByDate(dateStr) {
          const schedules = this.schedules[dateStr] || [];
          return ScheduleUtils.sortByTime(schedules);
        },

        // 获取指定日期的课程（显示格式，兼容旧界面）
        getDisplayScheduleByDate(dateStr) {
          const schedules = this.getScheduleByDate(dateStr);
          return schedules.map(schedule => ScheduleUtils.toDisplayFormat(schedule));
        },

        // 添加课程
        async addCourse(dateStr, courseData) {
          try {
            // 验证数据
            const validation = ScheduleUtils.validate(courseData);
            if (!validation.isValid) {
              throw new Error(validation.errors.join(', '));
            }

            // 创建新课程
            const newSchedule = ScheduleUtils.createNew(
              dateStr,
              courseData.start_time,
              courseData.end_time,
              courseData.course_name,
              courseData.course_type,
              courseData.note || ''
            );

            // 保存到数据库
            if (window.useSupabase && window.supabase) {
              const result = await DatabaseManager.saveSchedule(newSchedule);
              if (!result.success) {
                throw new Error(result.error);
              }
              // 数据库保存成功，更新本地数据
              if (!this.schedules[dateStr]) {
                this.schedules[dateStr] = [];
              }
              this.schedules[dateStr].push(newSchedule);
              this.schedules[dateStr] = ScheduleUtils.sortByTime(this.schedules[dateStr]);
            } else {
              // 直接保存到本地
              if (!this.schedules[dateStr]) {
                this.schedules[dateStr] = [];
              }
              this.schedules[dateStr].push(newSchedule);
              this.schedules[dateStr] = ScheduleUtils.sortByTime(this.schedules[dateStr]);
              this.saveToLocal();
            }

            return { success: true, data: newSchedule };
          } catch (error) {
            console.error('添加课程失败:', error);
            return { success: false, error: error.message };
          }
        },

        // 更新课程
        async updateCourse(courseId, updates) {
          try {
            // 找到原课程
            let originalSchedule = null;
            let dateStr = null;
            
            for (const date in this.schedules) {
              const schedule = this.schedules[date].find(s => s.id === courseId);
              if (schedule) {
                originalSchedule = schedule;
                dateStr = date;
                break;
              }
            }

            if (!originalSchedule) {
              throw new Error('课程不存在');
            }

            // 创建更新后的课程
            const updatedSchedule = {
              ...originalSchedule,
              ...updates,
              updated_at: new Date().toISOString()
            };

            // 验证更新后的数据
            const validation = ScheduleUtils.validate(updatedSchedule);
            if (!validation.isValid) {
              throw new Error(validation.errors.join(', '));
            }

            // 保存到数据库
            if (window.useSupabase && window.supabase) {
              const result = await DatabaseManager.updateSchedule(courseId, updatedSchedule);
              if (!result.success) {
                throw new Error(result.error);
              }
              // 更新本地数据
              const index = this.schedules[dateStr].findIndex(s => s.id === courseId);
              this.schedules[dateStr][index] = updatedSchedule;
              this.schedules[dateStr] = ScheduleUtils.sortByTime(this.schedules[dateStr]);
            } else {
              // 直接更新本地
              const index = this.schedules[dateStr].findIndex(s => s.id === courseId);
              this.schedules[dateStr][index] = updatedSchedule;
              this.schedules[dateStr] = ScheduleUtils.sortByTime(this.schedules[dateStr]);
              this.saveToLocal();
            }

            return { success: true, data: updatedSchedule };
          } catch (error) {
            console.error('更新课程失败:', error);
            return { success: false, error: error.message };
          }
        },

        // 删除课程
        async deleteCourse(courseId) {
          try {
            // 找到课程
            let dateStr = null;
            let courseIndex = -1;
            
            for (const date in this.schedules) {
              const index = this.schedules[date].findIndex(s => s.id === courseId);
              if (index !== -1) {
                dateStr = date;
                courseIndex = index;
                break;
              }
            }

            if (courseIndex === -1) {
              throw new Error('课程不存在');
            }

            // 删除数据库数据
            if (window.useSupabase && window.supabase) {
              const result = await DatabaseManager.deleteSchedule(courseId);
              if (!result.success) {
                throw new Error(result.error);
              }
              // 删除本地数据
              this.schedules[dateStr].splice(courseIndex, 1);
            } else {
              // 直接删除本地
              this.schedules[dateStr].splice(courseIndex, 1);
              this.saveToLocal();
            }

            return { success: true };
          } catch (error) {
            console.error('删除课程失败:', error);
            return { success: false, error: error.message };
          }
        },

        // 清理资源
        cleanup() {
          if (this.realtimeSubscription) {
            this.realtimeSubscription.unsubscribe();
          }
        }
      };

      // ================================
      // 课程管理业务逻辑层 - 结束
      // ================================

      // ================================
      // UI界面管理层 - 开始
      // ================================
      
      const UIManager = {
        currentDate: new Date(),

        // 格式化日期
        formatDate(date) {
          const year = date.getFullYear();
          const month = date.getMonth() + 1;
          const day = date.getDate();
          return `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
        },

        // 格式化显示日期
        formatDisplayDate(date) {
          const weekdays = ["周日", "周一", "周二", "周三", "周四", "周五", "周六"];
          const year = date.getFullYear();
          const month = date.getMonth() + 1;
          const day = date.getDate();
          const weekday = weekdays[date.getDay()];
          return `${year}年${month}月${day}日 ${weekday}`;
        },

        // 更新主界面显示
        updateDisplay() {
          const dateStr = this.formatDate(this.currentDate);
          const displayStr = this.formatDisplayDate(this.currentDate);
          const todayStr = this.formatDisplayDate(new Date());

          document.getElementById("currentDate").innerHTML = todayStr;
          document.getElementById("displayDate").innerHTML = displayStr;

          // 使用显示格式（兼容现有界面）
          const courses = ScheduleManager.getDisplayScheduleByDate(dateStr);
          const scheduleContent = document.getElementById("scheduleContent");

          if (courses.length === 0) {
            scheduleContent.innerHTML = '<div class="no-courses">🎉 今天没有安排课程，可以好好休息哦！</div>';
          } else {
            let html = "";
            courses.forEach(course => {
              html += `<div class="course-item course-${course.type}">
                        <div class="course-time">${course.time}</div>
                        <div class="course-name">${course.course}</div>
                      </div>`;
            });
            scheduleContent.innerHTML = html;
          }

          this.updateStats(courses);
        },

        // 更新统计信息
        updateStats(courses) {
          document.getElementById("totalCourses").innerHTML = courses.length;

          let totalHours = 0;
          courses.forEach(course => {
            const timeMatch = course.time.match(/(\d+):(\d+)-(\d+):(\d+)/);
            if (timeMatch) {
              const startHour = parseInt(timeMatch[1]);
              const startMin = parseInt(timeMatch[2]);
              const endHour = parseInt(timeMatch[3]);
              const endMin = parseInt(timeMatch[4]);
              const hours = (endHour * 60 + endMin - startHour * 60 - startMin) / 60;
              totalHours += hours;
            }
          });
          
          document.getElementById("courseHours").innerHTML = totalHours.toFixed(1);

          const categories = [...new Set(courses.map(c => c.category || "学科辅导"))];
          document.getElementById("categoryCount").innerHTML = categories.length;
        },

        // 改变日期
        changeDate(days) {
          this.currentDate.setDate(this.currentDate.getDate() + days);
          this.updateDisplay();
        },

        // 绑定事件
        bindEvents() {
          document.getElementById('prevBtn')?.addEventListener('click', () => this.changeDate(-1));
          document.getElementById('nextBtn')?.addEventListener('click', () => this.changeDate(1));
        },

        // 显示成功消息
        showSuccess(message) {
          alert('✅ ' + message);
        },

        // 显示错误消息
        showError(message) {
          alert('❌ ' + message);
        },

        // 显示确认对话框
        showConfirm(message) {
          return confirm('❓ ' + message);
        }
      };

      // ================================
      // UI界面管理层 - 结束
      // ================================

      // ================================
      // 编辑器模块 - 开始
      // ================================
      
      const EditorManager = {
        currentEditingId: null,
        isOpen: false,

        // 打开编辑器
        openEditor(date) {
          const today = new Date();
          const year = today.getFullYear();
          const month = today.getMonth() + 1;
          const day = today.getDate();
          const dateStr = date || `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
          
          document.getElementById('editDate').value = dateStr;
          document.getElementById('editorOverlay').style.display = 'flex';
          this.isOpen = true;
          
          this.loadDateCourses();
          this.clearForm();
        },

        // 关闭编辑器
        closeEditor() {
          document.getElementById('editorOverlay').style.display = 'none';
          this.isOpen = false;
          this.clearForm();
        },

        // 加载指定日期的课程列表
        loadDateCourses() {
          const dateStr = document.getElementById('editDate').value;
          if (!dateStr) return;

          const courses = ScheduleManager.getDisplayScheduleByDate(dateStr);
          let courseListHtml = '';

          if (courses.length === 0) {
            courseListHtml = '<div style="text-align: center; color: #666; padding: 20px;">📅 当前日期没有安排课程</div>';
          } else {
            courses.forEach(course => {
              courseListHtml += 
                `<div class="course-item-edit">
                  <div class="course-info">
                    <div class="course-time-edit">${course.time}</div>
                    <div class="course-name-edit">${course.course}</div>
                  </div>
                  <div class="course-actions">
                    <button class="btn-small btn-edit" onclick="handleEditCourse('${course.id}')">编辑</button>
                    <button class="btn-small btn-delete" onclick="handleDeleteCourse('${course.id}')">删除</button>
                  </div>
                </div>`;
            });
          }

          document.getElementById('courseList').innerHTML = courseListHtml;
        },

        // 设置快速时间
        setQuickTime(startTime, endTime) {
          document.getElementById('startTime').value = startTime;
          document.getElementById('endTime').value = endTime;
        },

        // 清空表单
        clearForm() {
          document.getElementById('startTime').value = '';
          document.getElementById('endTime').value = '';
          document.getElementById('courseName').value = '';
          document.getElementById('courseType').value = 'smk';
          document.getElementById('courseNote').value = '';
          document.getElementById('saveBtn').innerHTML = '➕ 添加课程';
          this.currentEditingId = null;
        },

        // 编辑课程
        editCourse(courseId) {
          // 找到课程数据
          let targetSchedule = null;
          
          for (const date in ScheduleManager.schedules) {
            const schedule = ScheduleManager.schedules[date].find(s => s.id === courseId);
            if (schedule) {
              targetSchedule = schedule;
              break;
            }
          }
          
          if (!targetSchedule) {
            UIManager.showError('课程不存在');
            return;
          }

          // 填充表单
          document.getElementById('startTime').value = targetSchedule.start_time;
          document.getElementById('endTime').value = targetSchedule.end_time;
          document.getElementById('courseName').value = targetSchedule.course_name;
          document.getElementById('courseType').value = targetSchedule.course_type;
          document.getElementById('courseNote').value = targetSchedule.note || '';
          document.getElementById('saveBtn').innerHTML = '✅ 更新课程';

          this.currentEditingId = courseId;
        },

        // 删除课程
        async deleteCourse(courseId) {
          if (!UIManager.showConfirm('确定要删除这门课程吗？')) return;

          try {
            const result = await ScheduleManager.deleteCourse(courseId);
            
            if (result.success) {
              this.loadDateCourses();
              UIManager.updateDisplay();
              UIManager.showSuccess('课程删除成功！');
            } else {
              UIManager.showError('删除失败: ' + result.error);
            }
          } catch (error) {
            UIManager.showError('删除失败: ' + error.message);
          }
        },

        // 保存课程
        async saveCourse() {
          const dateStr = document.getElementById('editDate').value;
          const startTime = document.getElementById('startTime').value;
          const endTime = document.getElementById('endTime').value;
          const courseName = document.getElementById('courseName').value.trim();
          const courseType = document.getElementById('courseType').value;
          const courseNote = document.getElementById('courseNote').value.trim();

          if (!dateStr || !startTime || !endTime || !courseName) {
            UIManager.showError('请填写完整的课程信息（日期、时间、课程名称为必填项）');
            return;
          }

          const courseData = {
            start_time: startTime,
            end_time: endTime,
            course_name: courseName,
            course_type: courseType,
            note: courseNote
          };

          try {
            let result;
            if (this.currentEditingId) {
              result = await ScheduleManager.updateCourse(this.currentEditingId, courseData);
              if (result.success) {
                UIManager.showSuccess('课程更新成功！');
              }
            } else {
              result = await ScheduleManager.addCourse(dateStr, courseData);
              if (result.success) {
                UIManager.showSuccess('课程添加成功！');
              }
            }

            if (result.success) {
              this.loadDateCourses();
              this.clearForm();
              UIManager.updateDisplay();
            } else {
              UIManager.showError('保存失败: ' + result.error);
            }
          } catch (error) {
            UIManager.showError('保存失败: ' + error.message);
          }
        }
      };

      // ================================
      // 编辑器模块 - 结束
      // ================================

      // ================================
      // 全局事件处理函数 - 开始
      // ================================
      
      // 编辑按钮点击
      function handleEditClick() {
        EditorManager.openEditor();
      }

      // 关闭编辑器
      function handleCloseEditor() {
        EditorManager.closeEditor();
      }

      // 加载日期课程
      function handleLoadDateCourses() {
        EditorManager.loadDateCourses();
      }

      // 设置快速时间
      function handleSetQuickTime(start, end) {
        EditorManager.setQuickTime(start, end);
      }

      // 编辑课程
      function handleEditCourse(courseId) {
        EditorManager.editCourse(courseId);
      }

      // 删除课程
      function handleDeleteCourse(courseId) {
        EditorManager.deleteCourse(courseId);
      }

      // 保存课程
      function handleSaveCourse() {
        EditorManager.saveCourse();
      }

      // ================================
      // 全局事件处理函数 - 结束
      // ================================

      // ================================
      // 应用初始化部分 - 开始
      // ================================
      
      // 初始化应用
      async function initApp() {
        console.log('🚀 初始化应用 - 使用统一数据模型');
        
        try {
          // 初始化数据管理器
          await ScheduleManager.init();
          
          // 初始化UI
          UIManager.updateDisplay();
          UIManager.bindEvents();
          
          console.log('✅ 应用初始化完成');
        } catch (error) {
          console.error('❌ 应用初始化失败:', error);
          UIManager.showError('应用初始化失败: ' + error.message);
        }
      }

      // 页面加载完成后初始化
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          if (!window.useSupabase) {
            initApp();
          }
        });
      } else {
        if (!window.useSupabase) {
          initApp();
        }
      }

      // 页面卸载时清理资源
      window.addEventListener('beforeunload', () => {
        ScheduleManager.cleanup();
      });

      // ================================
      // 应用初始化部分 - 结束
      // ================================
    </script>
  </body>
</html>
